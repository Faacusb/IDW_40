<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Obras Sociales - MedicalAssistance</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="CSS/estilos.css" />
    <link rel="icon" type="image/png" href="img/logo-mini.png" />
  </head>
  <body class="pagina-obras-sociales">
    <!-- Header -->
    <header>
      <nav class="navbar navbar-expand-lg border-bottom border-dark p-0">
        <div class="container-fluid flex-column flex-lg-column p-0">
          <div
            class="w-100 bg-primary text-white px-3 py-2 border-bottom border-dark d-flex justify-content-between align-items-center"
          >
            <a
              class="navbar-brand fw-bold text-white m-0 mx-auto d-none d-lg-block d-flex align-items-center gap-2"
              href="index.html"
            >
              <img src="img/logo.svg" alt="Logo" height="40" />
              <span>Medical Assistance</span>
            </a>
            <a
              class="navbar-brand fw-bold text-white m-0 d-lg-none d-flex align-items-center gap-2"
              href="index.html"
            >
              <img src="img/logo.svg" alt="Logo" height="30" />
              <span>Medical Assistance</span>
            </a>
            <button
              class="navbar-toggler menu-principal"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarNav"
              aria-controls="navbarNav"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
          </div>
          <div
            class="collapse navbar-collapse w-100 bg-white border-bottom border-dark"
            id="navbarNav"
          >
            <ul class="navbar-nav mx-auto gap-3 py-2">
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="index.html">Inicio</a>
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="institucional.html">Institucional</a>
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="contacto.html">Contacto</a>
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="turnos.html">Turnos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="login.html">Login</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Contenido -->
    <div class="container my-5">
      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Gestión de Obras Sociales</h2>
          <button class="btn btn-primary" id="btnAgregar">Agregar Obra Social</button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped align-middle text-center">
            <thead>
              <tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr>
            </thead>
            <tbody id="tablaObrasSociales"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modalObraSocial" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="tituloModal">Agregar Obra Social</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="formObraSocial" onsubmit="return false;">
              <div class="mb-3">
                <label for="idObraSocial" class="form-label">ID</label>
                <input type="number" id="idObraSocial" class="form-control" min="1" required />
              </div>
              <div class="mb-3">
                <label for="nombreObraSocial" class="form-label">Nombre</label>
                <input type="text" id="nombreObraSocial" class="form-control" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="guardarBtn">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-info text-dark text-center py-3 mt-auto">
      <p class="mb-0">Copyright &copy; 2025 Centro Médico Medical Assistance</p>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/autenticacion.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const token = sessionStorage.getItem('accessToken');
        const navList = document.querySelector('#navbarNav .navbar-nav');
        let user = null;
        if (token && typeof validateAndFetchUserData === 'function') {
          validateAndFetchUserData().then(u => {
            user = u;
            actualizarNav();
          }).catch(actualizarNav);
        } else {
          actualizarNav();
        }

        function actualizarNav() {
          const lastItem = navList.lastElementChild;
          if (lastItem && lastItem.querySelector('a[href="login.html"]')) lastItem.remove();
          const li = document.createElement('li');
          li.classList.add('nav-item');
          if (user) {
            li.innerHTML = `<a class="nav-link fw-bold text-dark" href="#" id="logoutLink">Logout (${user.username})</a>`;
            navList.appendChild(li);
            document.getElementById('logoutLink').addEventListener('click', (e) => {
              e.preventDefault();
              clearSession();
              window.location.href = 'index.html';
            });
          } else {
            li.innerHTML = `<a class="nav-link fw-bold text-dark" href="login.html">Login</a>`;
            navList.appendChild(li);
          }
        }
      });
    </script>

    <!-- Script funcional -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const tabla = document.getElementById('tablaObrasSociales');
        const btnAgregar = document.getElementById('btnAgregar');
        const idInput = document.getElementById('idObraSocial');
        const nombreInput = document.getElementById('nombreObraSocial');
        const tituloModal = document.getElementById('tituloModal');
        const guardarBtn = document.getElementById('guardarBtn');

        let modal;
        try {
          modal = new bootstrap.Modal(document.getElementById('modalObraSocial'));
        } catch (e) {
          console.error('No se pudo inicializar el modal:', e);
        }

        function cargarLocalStorage() {
          const raw = localStorage.getItem('obrasSociales');
          if (!raw) return [];
          try {
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
          } catch {
            return [];
          }
        }

        let obrasSociales = cargarLocalStorage();

        function renderizarTabla() {
          tabla.innerHTML = '';
          [...obrasSociales].sort((a, b) => a.id - b.id).forEach(obra => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${obra.id}</td>
              <td>${obra.nombre}</td>
              <td>
                <button class="btn btn-sm btn-warning me-2">Editar</button>
                <button class="btn btn-sm btn-danger">Eliminar</button>
              </td>
            `;
            tr.querySelector('.btn-warning').addEventListener('click', () => abrirEditar(obra.id));
            tr.querySelector('.btn-danger').addEventListener('click', () => eliminarObraSocial(obra.id));
            tabla.appendChild(tr);
          });
        }

        function sugerirId() {
          return obrasSociales.length ? Math.max(...obrasSociales.map(e => e.id)) + 1 : 1;
        }

        function abrirNueva() {
          idInput.value = sugerirId();
          nombreInput.value = '';
          tituloModal.textContent = 'Agregar Obra Social';
          modal.show();
          idInput.focus();
        }

        function abrirEditar(id) {
          const obra = obrasSociales.find(e => e.id === id);
          if (!obra) return alert('Obra Social no encontrada.');
          idInput.value = obra.id;
          nombreInput.value = obra.nombre;
          tituloModal.textContent = 'Editar Obra Social';
          modal.show();
          nombreInput.focus();
        }

        function guardarObraSocial() {
          const id = parseInt(idInput.value);
          const nombre = nombreInput.value.trim();
          if (!Number.isInteger(id) || id < 1) return alert('ID inválido.');
          if (!nombre) return alert('El nombre no puede estar vacío.');

          const index = obrasSociales.findIndex(e => e.id === id);
          if (index !== -1) {
            const confirmar = confirm(`El ID ${id} ya existe. ¿Desea sobrescribirlo?`);
            if (!confirmar) return;
            obrasSociales[index] = { id, nombre };
          } else {
            obrasSociales.push({ id, nombre });
          }
          salvarYRefrescar();
          modal.hide();
        }

        function eliminarObraSocial(id) {
          const obra = obrasSociales.find(e => e.id === id);
          if (!obra) return;
          if (!confirm(`¿Eliminar "${obra.nombre}" (ID ${obra.id})?`)) return;
          obrasSociales = obrasSociales.filter(e => e.id !== id);
          salvarYRefrescar();
        }

        function salvarYRefrescar() {
          localStorage.setItem('obrasSociales', JSON.stringify(obrasSociales));
          renderizarTabla();
        }

        btnAgregar.addEventListener('click', abrirNueva);
        guardarBtn.addEventListener('click', guardarObraSocial);

        if (!obrasSociales.length) {
          fetch('obras_sociales.json')
            .then(r => r.ok ? r.json() : [])
            .then(data => {
              if (Array.isArray(data)) {
                obrasSociales = data.map(d => ({ id: +d.id, nombre: String(d.nombre) }));
                localStorage.setItem('obrasSociales', JSON.stringify(obrasSociales));
              }
              renderizarTabla();
            })
            .catch(renderizarTabla);
        } else {
          renderizarTabla();
        }
      });
    </script>
  </body>
</html>
