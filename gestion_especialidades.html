<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Especialidades - MedicalAssistance</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="CSS/estilos.css" />
    <link rel="icon" type="image/png" href="img/logo-mini.png" />
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-lg border-bottom border-dark p-0">
        <div class="container-fluid flex-column flex-lg-column p-0">
          <div
            class="w-100 bg-primary text-white px-3 py-2 border-bottom border-dark d-flex justify-content-between align-items-center"
          >
            <a
              class="navbar-brand fw-bold text-white m-0 mx-auto d-none d-lg-block d-flex align-items-center gap-2"
              href="index.html"
            >
              <img src="img/logo.svg" alt="Logo" height="40" />
              <span>Medical Assistance</span>
            </a>
            <a
              class="navbar-brand fw-bold text-white m-0 d-lg-none d-flex align-items-center gap-2"
              href="index.html"
            >
              <img src="img/logo.svg" alt="Logo" height="30" />
              <span>Medical Assistance</span>
            </a>
            <button
              class="navbar-toggler menu-principal"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarNav"
              aria-controls="navbarNav"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
          </div>
          <div
            class="collapse navbar-collapse w-100 bg-white border-bottom border-dark"
            id="navbarNav"
          >
            <ul class="navbar-nav mx-auto gap-3 py-2">
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="gestionMedicos.html"
                  >Gestión de medicos</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="altaMedicos.html"
                  >Alta de Medicos</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link fw-bold text-dark active"
                  href="gestion_especialidades.html"
                  >Gestión de Especialidades</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link fw-bold text-dark"
                  href="gestion_obrasocial.html"
                  >Gestión de Obra Sociales</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link fw-bold text-dark"
                  href="administracion-turnos.html"
                  >Gestión de Turnos</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="usuarios.html"
                  >Gestión de Usuarios</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link fw-bold text-dark" href="index.html"
                  >Log out</a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>
    <div class="container my-5">
      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Gestión de Especialidades</h2>
          <button class="btn btn-primary" id="btnAgregar">
            Agregar Especialidad
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped align-middle text-center">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaEspecialidades"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="modalEspecialidad"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="tituloModal">Agregar Especialidad</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formEspecialidad" onsubmit="return false;">
              <div class="mb-3">
                <label for="idEspecialidad" class="form-label">ID</label>
                <input
                  type="number"
                  id="idEspecialidad"
                  class="form-control"
                  min="1"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="nombreEspecialidad" class="form-label"
                  >Nombre</label
                >
                <input
                  type="text"
                  id="nombreEspecialidad"
                  class="form-control"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="guardarBtn">
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <footer class="bg-info text-dark text-center py-3 mt-auto">
      <p class="mb-0">Copyright &copy; 2025 Centro Médico Medical Assistance</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/autenticacion.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@materialstyle/materialstyle@3.1.1/dist/js/materialstyle.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tabla = document.getElementById("tablaEspecialidades");
      const btnAgregar = document.getElementById("btnAgregar");
      const idInput = document.getElementById("idEspecialidad");
      const nombreInput = document.getElementById("nombreEspecialidad");
      const tituloModal = document.getElementById("tituloModal");
      const guardarBtn = document.getElementById("guardarBtn");

      let modal = new bootstrap.Modal(document.getElementById("modalEspecialidad"));

      function cargarLocales() {
        try {
          const lista = JSON.parse(localStorage.getItem("especialidades"));
          return Array.isArray(lista) ? lista : [];
        } catch {
          return [];
        }
      }

      function cargarEliminadas() {
        try {
          const ids = JSON.parse(localStorage.getItem("especialidadesEliminadas"));
          return Array.isArray(ids) ? ids.map(Number) : [];
        } catch {
          return [];
        }
      }

      async function cargarCombinado() {
        const res = await fetch("data/especialidades.json?v=" + Date.now(), { cache: "no-store" });
        const base = res.ok ? await res.json() : [];

        const locales = cargarLocales();
        const eliminadas = cargarEliminadas();

        let lista = base.filter(e => !eliminadas.includes(Number(e.id)));

        locales.forEach(loc => {
          const idx = lista.findIndex(e => Number(e.id) === Number(loc.id));
          if (idx !== -1) lista[idx] = loc;
          else lista.push(loc);
        });

        return lista.sort((a, b) => a.id - b.id);
      }

      let especialidades = [];

      async function inicializar() {
        especialidades = await cargarCombinado();

        localStorage.setItem("especialidades", JSON.stringify(especialidades));
        renderizarTabla();
      }

      function renderizarTabla() {
        tabla.innerHTML = "";

        especialidades.forEach(esp => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esp.id}</td>
            <td>${esp.nombre}</td>
            <td>
              <button class="btn btn-sm btn-warning me-2">Editar</button>
              <button class="btn btn-sm btn-danger">Eliminar</button>
            </td>
          `;

          tr.querySelector(".btn-warning").addEventListener("click", () => abrirEditar(esp.id));
          tr.querySelector(".btn-danger").addEventListener("click", () => eliminarEspecialidad(esp.id));
          tabla.appendChild(tr);
        });
      }

      function sugerirId() {
        return especialidades.length
          ? Math.max(...especialidades.map(e => Number(e.id))) + 1
          : 1;
      }

      function abrirNueva() {
        idInput.value = sugerirId();
        nombreInput.value = "";
        tituloModal.textContent = "Agregar Especialidad";
        modal.show();
      }

      function abrirEditar(id) {
        const esp = especialidades.find(e => Number(e.id) === Number(id));
        if (!esp) return;

        idInput.value = esp.id;
        nombreInput.value = esp.nombre;
        tituloModal.textContent = "Editar Especialidad";
        modal.show();
      }

      function guardarEspecialidad() {
        const id = Number(idInput.value);
        const nombre = nombreInput.value.trim();

        if (!id || !nombre) return;

        const idx = especialidades.findIndex(e => Number(e.id) === id);

        if (idx !== -1) {
          especialidades[idx] = { id, nombre };
        } else {
          especialidades.push({ id, nombre });
        }

        localStorage.setItem("especialidades", JSON.stringify(especialidades));
        renderizarTabla();
        modal.hide();
      }

      function eliminarEspecialidad(id) {
        const esp = especialidades.find(e => Number(e.id) === Number(id));
        if (!esp) return;

        if (!confirm(`¿Eliminar "${esp.nombre}"?`)) return;

        especialidades = especialidades.filter(e => Number(e.id) !== Number(id));

        localStorage.setItem("especialidades", JSON.stringify(especialidades));

        let eliminadas = cargarEliminadas();
        if (!eliminadas.includes(id)) {
          eliminadas.push(id);
          localStorage.setItem("especialidadesEliminadas", JSON.stringify(eliminadas));
        }

        renderizarTabla();
      }

      btnAgregar.addEventListener("click", abrirNueva);
      guardarBtn.addEventListener("click", guardarEspecialidad);

      inicializar();
    });
    </script>

    </script>
  </body>
</html>
